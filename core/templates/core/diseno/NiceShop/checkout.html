{% extends 'core/diseno/NiceShop/base.html' %}
{% load static %}
{% load carrito_filters %}
{% block content %}

<main class="main">
    
  <script src="https://www.paypal.com/sdk/js?client-id=AbH3kReloqliHjc6WOggaPNsmJHWAqHt3sW88a-MS5JFP0BnwJM301HgHqADBsJdk8XIR5MgGueLO2xx&currency=MXN"></script>

  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">Orden de compra</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{% url 'confirma_orden_paypal' %}">Orden ok</a></li>
          <li><a href="{% url 'carrito' %}">Regresar</a></li>
          <li><a href="{% url 'home' %}">Inicio</a></li>
          <li class="current">Checkout</li>
        </ol>
      </nav>
    </div>
  </div>

  <section id="checkout" class="checkout section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">
      <div class="row">
        <!-- Formulario Cliente y Dirección -->
        <div class="col-lg-7">
          <div class="checkout-container" data-aos="fade-up">
            <form id="checkout-form">
              <!-- Información del cliente -->
               <!--
              <div class="checkout-section">
                <h3>Información del cliente</h3>
                <div class="row">
                  <div class="col-md-6 form-group">
                    <input type="text" id="first-name" class="form-control" placeholder="Nombre" required>
                  </div>
                  <div class="col-md-6 form-group">
                    <input type="text" id="last-name" class="form-control" placeholder="Apellidos" required>
                  </div>
                </div>
                <div class="form-group">
                  <input type="email" id="email" class="form-control" placeholder="Correo" required>
                </div>
                <div class="form-group">
                  <input type="tel" id="phone" class="form-control" placeholder="Teléfono" required>
                </div>
              </div>
            -->
              <!-- Dirección -->
               <!--
              <div class="checkout-section">
                <h3>Domicilio</h3>
                <div class="form-group">
                  <input type="text" id="address" class="form-control" placeholder="Calle" required>
                </div>
                <div class="form-group">
                  <input type="text" id="apartment" class="form-control" placeholder="Número exterior / interior">
                </div>
                <div class="row">
                  <div class="col-md-4 form-group">
                    <input type="text" id="city" class="form-control" placeholder="Ciudad" required>
                  </div>
                  <div class="col-md-4 form-group">
                    <input type="text" id="state" class="form-control" placeholder="Estado" required>
                  </div>
                  <div class="col-md-4 form-group">
                    <input type="text" id="zip" class="form-control" placeholder="Código postal" required>
                  </div>
                </div>
                <div class="form-group">
                  <select id="country" class="form-select" required>
                    <option value="">Selecciona país</option>
                    <option value="MX">México</option>
                    <option value="US">United States</option>
                  </select>
                </div>
              </div>
            -->
              <!-- Pago -->
               <!--
              <div class="checkout-section">
                <h3>Método de pago</h3>
                <div class="payment-options">
                  <div class="payment-option">
                    <input type="radio" name="payment-method" id="paypal" checked>
                    <label for="paypal">
                      <i class="bi bi-paypal"></i> PayPal
                    </label>
                  </div>
                </div>
              </div>
            -->
              <!-- Orden y botón -->
              <div class="checkout-section">
                <h3>Revisa & Realiza el pedido</h3>
                <div class="form-check terms-check">
                  <input class="form-check-input" type="checkbox" id="terms" required>
                  <label class="form-check-label" for="terms">
                    Acepto <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Términos y Condiciones</a> y 
                    <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Políticas de Privacidad</a>
                  </label>
                </div>

                <button type="button" id="btnPagar" class="btn btn-primary mt-3" onclick="pagoPaypal()">
                  Realizar pedido - ${{ carrito.total_general|floatformat:2 }}
                </button>
                  <!-- Contenedor oculto para PayPal -->
                <div id="paypal-button-container"></div>
              </div>
            </form>
          </div>
        </div>

        <!-- Resumen de orden -->
        <div class="col-lg-5">
          <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
            <h3>Resumen de orden</h3>
            <span class="item-count">{{ carrito.piezas|default:0 }} llanta{% if carrito.piezas|default:0 != 1 %}s{% endif %}</span>
            {% for pk, renglon in carrito.items %}
              {% if pk|isdigit %}
                <div class="order-item d-flex justify-content-between">
                  <div>
                    <strong>{{ renglon.razon_social }}</strong><br>
                    <small>{{ renglon.descripcion }}</small>
                  </div>
                  <div>
                    {{ renglon.cantidad }} x ${{ renglon.precio }} = ${{ renglon.total }}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            <hr>
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span>${{ carrito.subtotal }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>I.V.A.</span>
              <span>${{ carrito.iva_total }}</span>
            </div>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <span>${{ carrito.total_general }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
    function pagoPaypal() {
        // Oculta el botón original para que no se vea junto a PayPal
        $('#btnPagar').hide();

        // Limpia el botón PayPal antes de renderizar (evita múltiples botones)
        $('#paypal-button-container').empty();

        const importeInput ='{{ carrito.total_general }}';
        const totalImporte = parseFloat(importeInput.replace(/[$,]/g, ''));

        if (isNaN(totalImporte) || totalImporte <= 0) {
            alert("⚠️ No hay un importe válido para pagar.");
            return;
        }

//
          paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: totalImporte.toFixed(2)
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {  
//
                    // Enviar datos al backend
                    fetch("{% url 'registrar_venta_paypal' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
/*                          
                            order_id: 2,
                            nombre: 'enrique',
                            email: 'evallardy@gmail.com',
                            nombre_completo: 'enrique vallardy',
                            direccion: 'Calle',
                            ciudad: 'ciudad',
                            estado: 'DF',
                            cp: '02160',
                            pais: 'México',
                            fecha_creacion: '2025-08-09 02:42:06.398127',
                            total: totalImporte,
*/                            
//
                            order_id: data.orderID,
                            nombre: details.payer.name.given_name + " " + details.payer.name.surname,
                            email: details.payer.email_address,
                            nombre_completo: details.purchase_units[0].shipping.name.full_name,
                            direccion: details.purchase_units[0].shipping.address.address_line_1,
                            colonia: details.purchase_units[0].shipping.address.address_line_2,
                            ciudad: details.purchase_units[0].shipping.address.admin_area_2,
                            estado: details.purchase_units[0].shipping.address.admin_area_1,
                            cp: details.purchase_units[0].shipping.address.postal_code,
                            pais: details.purchase_units[0].shipping.address.country_code,
                            fecha_creacion: details.create_time,
                            total: totalImporte,
                            telefono: details.purchase_units[0].shipping.phone_number,
//                          
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'ok') {
                            window.location.href = "{% url 'confirma_orden_paypal' %}";
//
                          $('#tbl-detalle').empty();
                            // Mostrar modal de confirmación
                            $.each(result.compras, function(index, item) {
                                let fila = `
                                    <tr>
                                        <td>${item.id}</td>
                                        <td>${item.taller}</td>
                                        <td>${item.descripcion}</td>
                                        <td>${item.cantidad}</td>
                                        <td>${item.token}</td>
                                    </tr>
                                `;
                                $('#tbl-detalle').append(fila);
                            });
                            graciasModal = new bootstrap.Modal(document.getElementById('graciasModal'));
                            graciasModal.show();
//                            
                        } else {
                            alert("❌ Error en backend: " + result.error);
                        }
                    });
//
                });
            },
            onError: function(err) {
                console.error(err);
                alert('❌ Error en el proceso de pago.');
            }
        }).render('#paypal-button-container');
//
    }
</script>
{% endblock %}
